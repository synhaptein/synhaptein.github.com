---
layout: post
title: OpenIndiana KVM startup script
categories: 
- synhaptein
---
<p>
This week, I tried the new openindiana release 151a to use kvm. There's a good post from Gray Matter Boundaries, <a class="readmore" href="http://www.graymatterboundaries.com/?p=158">Installing KVM and Creating a Debian VM in OpenIndiana 151a</a>. I installed a first vm and it works nicely! So how do I start it automatically? I'm not a sysadmin, but I create a smf and a bash script that start every *.sh in /etc/kvm. It's simple, probably not perfect and it won't halt your vms on reboot/halt, but it did what I needed! Maybe it will help someone else. By the way, if you find a bug or want to suggest an improvement, just email me at philippe.lheureux (at) umontreal.ca!
</p>
<p>
/etc/init.d/kvm (the startup script):
</p>
<div class="codeblock">
{% highlight bash %}
#!/bin/sh

FILES=/etc/kvm/*.sh

for f in $FILES
do
        $f &
done
{% endhighlight %}
</div>

<p>
kvm.xml (smf config)
</p>
<div class="codeblock">
{% highlight xml %}
<?xml version="1.0"?>
<!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1">
<service_bundle type='manifest' name='kvm'>
   <service name='system/kvm' type='service' version='1'>
     <create_default_instance enabled='false' />
     <single_instance/>
     <dependency name='multi-user-server'
          grouping='require_all'
          restart_on='none'
          type='service'>
        <service_fmri value='svc:/milestone/multi-user-server:default'/>
      </dependency>
     <exec_method type='method' name='start' exec='/etc/init.d/kvm' timeout_seconds='-1' />
     <exec_method type='method' name='stop' exec=':kill' timeout_seconds='-1' />
     <stability value='Unstable' />
     <template>
     <common_name>
       <loctext xml:lang='C'> KVM start </loctext>
     </common_name>
     </template> 
    </service>
 </service_bundle>
{% endhighlight %}
</div>

<p>
Install the smf config for kvm
</p>
<div class="codeblock">
{% highlight bash %}
svccfg import kvm.xml
svcadm enable kvm
{% endhighlight %}
</div>

<p>
That's it, your vms should be start next startup!
</div>